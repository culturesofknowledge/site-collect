<?xml version="1.0" encoding="UTF-8"?><html>
   <head>
      <meta charset="utf-8"></meta>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
      <title>Prosopography Input Form</title>
     
     
      <script src="../jquery-1.11.1.min.js"></script>
      <script src="../jquery-ui-1.10.4/js/jquery-ui-1.10.4.js"></script>
      <script src="../select2-3.5.1/select2.js"></script>
      <script src="../f5/js/vendor/modernizr.js"></script>
      <script src="./js/form.js"></script>
      <script src="../typeahead.bundle.js"></script>
      <script src="./js/family.js"></script>
      
      
      <link rel="stylesheet" href="../select2-3.5.1/select2.css" ></link>
      <link rel="stylesheet" href="../f5/css/foundation.css"></link>
      <link rel="stylesheet" href="../f5/css/foundation-icons.css"></link>
      <link rel="stylesheet" href="css/style.css"></link>
   </head>
   <body>
      <form method="post" id="form1" name="form1" data-abide="">
     
		<fieldset>
<fieldset class="">
			 <span class="submitForm button tiny"> Save Activity </span>
			<span class="resetForm button tiny"> Reset Form </span>
				<span class="Browse button tiny">Browse All Activities </span>
<span id="messages"/>
</fieldset>


<fieldset id="fieldsetPrimaryPerson">
</fieldset>


			<fieldset id="fieldsetActivity" class="">
				<legend>Activity</legend>
				<ul class="small-block-grid-4">
					<li><label>Activity Type</label> <input type="hidden"
						name="activity_type" class="Activity small-12" /></li>
					<li><label>Activity Name</label> <input class="small-12"
					name="activity_name"	></input></li>
					<li><label>Activity Description</label> <textarea
						name="activity_description"	 class="small-12"></textarea></li>
					<li/>
				</ul>
			</fieldset>
			<fieldset id="fieldsetRole" class="fieldsetRole">
				
			</fieldset>
			<fieldset id="fieldsetTime">
				<legend>Time</legend>
				<label>Date type</label> <select name="date_type" class="SelectFilter DateType small-2">
					<option value="">Please select...</option>
					<option value="Before">Before</option>
					<option value="After">After</option>
					<option value="Duration">Duration</option>
					<option value="Between">Between</option>
				</select> <br />
				<br />
				<ul class="small-block-grid-4">

					<li><label for="date_from_year">Year From</label> <input
						name="date_from_year" type="text" class="small-6" placeholder="Enter year" pattern="^[0-9]{4}$"/>
						 <small class="error">Year entered is not valid</small>
						</li>
					<li><label for="date_from_month">Month From</label> <input
						name="date_from_month" type="hidden" class="small-6 Month" /></li>
					<li><label for="date_from_day">Day From</label> <input type="hidden"
					name="date_from_day"	class="small-6 Day" /></li>
					<li><label for="date_from_uncertainty">Uncertainty</label> <input type="hidden"
						name="date_from_uncertainty"class="Uncertainty small-6" /></li>
					
					<li><label for="date_to_year">Year To</label> <input
					name="date_to_year"	type="text" placeholder="Enter year" class="small-6" pattern="^[0-9]{4}$"/>
					<small class="error">Year entered is not valid</small></li>
					<li><label for="date_to_month">Month To</label> <input
						name="date_to_month" type="hidden" class="small-6 Month" /></li>
					<li><label for="date_to_day">Day To</label> <input type="hidden"
					name="date_to_day"	class="small-6 Day" /></li>
					<li><label for="date_to_uncertainty">Uncertainty</label> <input type="hidden"
					name="date_to_uncertainty"class="Uncertainty small-6" /></li>
				</ul>
			</fieldset>

			<fieldset id ='fieldsetLocation'>
				<legend>Location</legend>

				<ul class="small-block-grid-4">
					<li><label for="location">Location </label> <input type="hidden"
					name="location_id_1"	class="Location small-12" value="" /></li>
					<li><br />
					<span class="addLocation button tiny">Add</span>&nbsp;</li>
				
				<li>If the location does not appear in the selection, you can add a location to the selection using the EMLO Edit <a target="_new" href="https://emlo-edit.bodleian.ox.ac.uk/interface/union.php?menu_item_id=39"> "Add New Place" </a> form.</li>
				</ul>

			</fieldset>

			<fieldset>
				<legend>Textual Source</legend>
				<ul class="small-block-grid-4">
					<li><label for="source_id_1">Textual Source</label>  <input type="hidden" name="source_id_1" class="TextualSource small-12" value=""/></li>
					<li><label for="source_details_1">Source Details</label> <textarea id="sourceDetails"
						name="source_details_1"	class="sourceDetail small-12"></textarea></li>

					<li><br />
					<span id="add" class="addSource button tiny">Add</span></li>

				</ul>

			</fieldset>
			<fieldset>
				<legend>Data Source</legend>

				<ul class="small-block-grid-2">
					<li><label for="notes_used">Contributing Authors</label> <input
					name="notes_used"	 class=" small-12"></input></li>
					
				</ul>
			</fieldset>
			<fieldset>
				<legend>Additional Notes</legend>

				<ul class="small-block-grid-2">
					
					<li><label for="additional_notes">Additional Notes</label> <textarea
						name="additional_notes"	 class=" small-12"></textarea></li>

					

					
				</ul>
			</fieldset>
		</fieldset>
	</form>
     
 <script src="js/config.js"></script>
 <script src="js/formFunctions.js"></script>
<script src="js/formActions.js"></script>
<script src="../f5/js/foundation/foundation.js"></script>
<script src="../f5/js/foundation/foundation.abide.js"></script>

    <!--    <script src="/f5/js/foundation.min.js"></script> --> 
      <script> $(document).foundation();</script>
      
      
<script>


/*
INITIALISE FORM FIELDS
*/
      
     $(document).ready(function() { 
    	 $(".SelectFilter").select2(); 
         
         addSelect2($(".Location"), "Select a location", urlPlace, "item.emloid", "item.label", "jsonp");
        // addSelect2Person($(".PersonPrimary"), "Select a person", urlPerson, "jsonp");
       
         $(".Month").select2({data:arrayMonth});         
         $(".Day").select2({data:arrayDay});
         $(".Uncertainty").select2({data:arrayUncertain});

        
    	                     
     });  


 
 /* ACTIVITY DESCRIPTION */
 
 // populate Activity field with list of activities from activityGroup.json file 
         $.getJSON("data/activityGroup.json", function(json) {            	 
        	 $(".Activity").select2({ data:json })
         });
    	                     
// get activity id from request parameters
var id = getParameterByName('id');

// define query to return selected activity
var url = urlActivitySelect + "?id=" + id;

// get activity record as json file and load data into input form
$.getJSON(url,function(data){
			$.each(data, function(i,data){
						
				// set values of input fields that are not repeatable
		
				// POPULATE ACTIVITY DESCRIPTION 
				$(".Activity").select2("val", data.activity_type_id);
				$("input[name='activity_name']").val(data.activity_name);
				$("textarea[name='activity_description']").val(data.activity_description);
				
				// POPULATE DATE VALUES
				$(".DateType").select2("val", data.date_type);
				$("input[name='date_from_year']").val(data.date_from_year);
				$("input[name='date_from_month']").select2("val", data.date_from_month);
				$("input[name='date_from_day']").select2("val", data.date_from_day);
				$("input[name='date_from_uncertainty']").select2("val", data.date_from_uncertainty);
				
				$("input[name='date_to_year']").val(data.date_to_year);
				$("input[name='date_to_month']").select2("val", data.date_to_month);
				$("input[name='date_to_day']").select2("val", data.date_to_day);
				$("input[name='date_to_uncertainty']").select2("val", data.date_to_uncertainty);
				
				
				// POPULATE TEXTUAL SOURCES
				addSelect2Param($(".TextualSource"), "Select a textual source", urlTextualSource, "item.emloid", "item.label", "json");
         
				var htmlTextualSource = "";
				
				// iterate through each assertion in the dataset
				$.each(data.assertion, function(i,assertion){		
					var count = i + 2;	// start counter at 2
					
				// source description
					sourceDetailValue = assertion.source_description;
					source_id = assertion.source_id;
					 
					// define HTML for each textual source
					htmlTextualSource =  
   	    			'<ul class="small-block-grid-4 textSourceEntry">' +
   	    			'<li><label>Textual Source</label><textarea  readonly name="source_id_' + count +  '" class="input_source_id_' + count +  '  TextualSource small-12" >' + source_id + '</textarea></li>' +
   	    			'<li><label>Source Details</label><input type="text" name="source_details_' + count + '" class="small-block-grid-4" readonly value="' + sourceDetailValue + '"/>' +
   	    			'</li><li>' +
   	    			'<span class="remove button tiny">X</span>' +
   	    			'</li></ul>' ;
   	    		
					// append HTML to textual source section
					$('.addSource').parents("fieldset").first().append(htmlTextualSource); 
					
					// GET TEXT LABEL FOR THE TEXTUAL SOURCE AND POPULATE READONLY TEXTAREA 
					 getTextualSourceText(source_id, '.input_source_id_' + count );
				});
				
				// POPULATE NOTES 
				$("input[name='notes_used']").val(data.notes_used);
				$("textarea[name='additional_notes']").val(data.additional_notes);
				
				
				// POPULATE PRIMARY PERSON
				
				// get id for primary person
				// problem with input field because it only returns values when at least one character is entered
				// look at nextweek
				//	$("input[name='subject']").val("902275");
				
				var subject_id = data.relationship[0].subject_id;
				
				getPersonText(subject_id, "#fieldsetPrimaryPerson");
				
				// POPULATE LOCATION
				$.each(data.location, function(i,location){		
					var count = i + 2;	// start counter at 2
					
					var locationid = location.location_id;

					html = 
      	    			'<legend>Primary Person</legend><ul class="small-block-grid-4 AddedLocation"><li>' +
      	    			'<input type="text" name="location_' + count + '" class="location_' + count + ' columns small-10" readonly value=""/>' +
      	    			'<input type="hidden" name="location_id_' + count + '" value="' + locationid + '"/></li><li>' +
      	    			'<span class="remove button tiny ">X</span>' +
      	    			'</li></ul>' ;
					
      	    			
					// append HTML to textual source section
					$('.addLocation').parents("fieldset").first().append(html); 	
					
					 getLocationText(locationid, '.location_' + count);
				});

				// POPULATE ROLES AND RELATIONSHIPS
				/*
				$.each(data.relationship, function(i,relation){
						
				});
				
				*/
				
				
					
					
					$("#fieldsetRole").html('<legend>Roles and Relationships</legend>'); 
		      				
					
					
				var countRole = 1;
				var html = "";
				
				$.each(data.role_in_activity, function(i,role){

					if ((role.entity_id == subject_id) && (role.entity_type = "Person")){
						
						html += 
							'<div class="divRole" >' +
								'<ul class="small-block-grid-4">' +
								'	<li><label>Role</label> ' +
								'<input type="hidden" name="subject_role_' + countRole +'" class="Role small-12" value="' + role.role_id + '" /></li>' +
									'<li><br /> <span class="addRole button tiny">Add</span> <span class="remove button tiny">Remove</span></li>' +
								'</ul>' +
								'<div class="divRel">' +
								
					 				'<p>Describe the relationships that correspond to the person having the selected role in this activity:</p>' +
					 				'<ul class="small-block-grid-5">' +
					 				'<li>' +
					 				'<label>Relationship Type</label>' +
					 				'<input type="hidden" name="relationship_1_' + countRole + '" class="Relationship small-12" />' +
					 				'</li><li>' +
					 				'<label>Entity Type</label>' +
					 				'<select name="object_type_1_' + countRole + '" class="small-12 Object_Type" >' +
					 				'<option value="">Please Select...</option>' +
					 				'<option value="Document">Document</option>' + 
					 				'<option value="Organisation">Organisation</option>' +
					 				'<option value="Person">Person</option>' +
					 				'<option value="Entity">Other entity type not specified</option>' +
					 				'</select>' +
					 				' </li>' +
					 				' <li><div class="divEntity"/></li>' +
					 				' <li><div class="divRole2"/></li>' +
					 				' <li><br/>' +
					 				'<span id="add" class="addRelationship button tiny" >Add</span>' +
					 				'</li>' +
					 				'</ul>'+
							'</div><hr/>';
					}
					
					countRole += 1;
					
					
				});
				
				$("#fieldsetRole").last().append(html);
			  	// read activityRole.json file containing association between activity type and roles
			  	/*
	         	$.getJSON("data/roleRelationship.json", function(json2) {  
	         		
		
	         		var items = [];
	         		
	         		// iterate through json file 
	         		$.each(json2, function(i, v) {
	         			
	         			// if the identifier of an activity type in the json file matches the selected value
	         			// populate the role selection fields with the element and its child roles
	         			 if (v.id == selectedValue) {      
	         				 
	         				 	$(obj).parents(".divRole").find(".divRel").html(html);
	         				 	$(obj).parents(".divRole").find(".Relationship").select2({ data:  [ v ] });
	         			        return;
	         			    } 
	         			});
	  
	              });*/
				
			});
			
			
			
			
			
			
			return false;

});


function getPersonText(personid, elementid){
	
	var url = urlPersonAll + "?id=" + personid;

	var returnValue = "";
	
	 $.getJSON(url,function(urlPersonAll){
				$.each(urlPersonAll, function(i,person){
						if (person.emloid == personid) { 	
							returnValue = person.name;
							return;
						}
						});
	 

				var html = 
					 '<legend>Primary Person</legend><ul class="small-block-grid-2"><li><label>Person</label>' +
					 '<input type="text" readonly name="subject"  id="PersonPrimary" class="Person PersonPrimary small-12" value="' + returnValue + '"/>' +
					 '</li><li><br/><span class="button tiny removePrimaryPerson">X</span>' +
					 '</li></ul>' ;
				$(elementid).html(html);
	 });
	 
	 
	 
	 
				
				
	 
	 
	 
	 

	 
	 
	 


}



function getLocationText(id, elementid){

	var url = urlPlaceAll + "?id=" + id; // retrieve json file for selected textual source

	var returnValue = "";
	
	 $.getJSON(url,function(locationAll){
				$.each(locationAll, function(i,location){
						if (location.emloid == id) { 	returnValue = location.label;
						
						
						
						}
						});
				
				$(elementid).val(returnValue);
				
				});	
	
	 
}




// get text label for textual source
function getTextualSourceText(sourceid, elementid){
	
	var url = urlTextualSource + "?id=" + sourceid; // retrieve json file for selected textual source
	
	var returnValue = "";
	
	 $.getJSON(urlTextualSource,function(sourceAll){
				$.each(sourceAll, function(i,source){
						if (source.emloid == sourceid) { 	returnValue = source.label;}
						});
				
				$(elementid).val(returnValue);
				
				});	
	
	 
}






</script>
      
      
   </body>
</html>
